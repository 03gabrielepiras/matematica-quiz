<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />

  <!-- iOS/Android PWA: NO zoom accidentale -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <meta name="theme-color" content="#0b0f17" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="styles.css" />

  <title>œÄ 1GL1-GL2 ‚Ä¢ Matematica</title>
</head>

<body>
  <!-- Header identit√† -->
  <header class="topbar">
    <div class="wrap topbar__inner">
      <div class="brand">
        <div class="brand__icon" aria-hidden="true">œÄ</div>
        <div class="brand__text">
          <div class="brand__school">1GL1-GL2 ‚Äì Matematica ‚Äì Algebra</div>
          <div class="brand__title">Prof. G. Gentili</div>
        </div>
      </div>

      <div class="topbar__right">
        <div id="appVersion" class="pill">v15</div>
        <div id="hello" class="pill hidden"></div>
        <button id="settingsTopBtn" class="btn" type="button" title="Impostazioni">&#9881;</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- ONBOARDING NOME (solo prima volta) -->
    <section class="card" id="onboarding">
      <h2>Chi sei?</h2>
      <p class="muted">Scrivi il tuo nome (rimane salvato nella PWA).</p>

      <div class="grid one">
        <label class="field">
          <span>Nome</span>
          <input id="nameInput"
                 type="text"
                 placeholder="Es. Gabriele"
                 autocomplete="off"
                 autocorrect="off"
                 autocapitalize="off"
                 spellcheck="false" />
        </label>
      </div>

      <div class="actions">
        <button id="saveNameBtn" class="btn primary">Continua</button>
      </div>
    </section>

    <!-- HOME -->
    <section class="card hidden" id="home">
      <div class="homeHead">
        <div>
          <h2>Allenamento e Verifiche</h2>
          <p class="muted">Percorso guidato con prerequisiti (P0 ‚Üí M1 ‚Üí M2 ‚Üí M3 ‚Üí M4 ‚Üí M5).</p>
        </div>
        <div class="pill" id="statusPill">Stato: ‚Äî</div>
      </div>

      <!-- progressi sintetici + badge (riempiti da quiz.js) -->
      <div id="dashboard" class="dashboard"></div>

      <div class="divider"></div>

      <h3>Classe</h3>
      <p class="muted tiny">Vedi chi sta usando l‚Äôapp in classe e a che percentuale √® arrivato (serve connessione).</p>
      <div id="classmates" class="classmates"></div>

      <div class="actions">
        <button id="trainBtn" class="btn primary">Allenati (consigliato)</button>
        <button id="verifyBtn" class="btn">Verifica</button>
        <button id="progressBtn" class="btn">Progressi</button>
      </div>

      <div class="divider"></div>

      <!-- selezione blocco (se consentita) -->
      <h3>Blocchi</h3>
      <div id="blocks" class="blocks"></div>

      <p class="muted tiny" id="homeHint"></p>
    </section>

    <!-- QUIZ -->
    <section class="card hidden" id="quiz">
      <div class="quizHead">
        <div>
          <h2 id="quizTitle">Domanda</h2>
          <p class="muted" id="meta"></p>
        </div>
        <div class="pill" id="scorePill">Punti: 0</div>
      </div>

      <div class="progress">
        <div class="progress__bar" id="progressBar"></div>
      </div>

      <!-- Post-it regola + esempio (sempre in Allenamento) -->
      <div class="note" id="ruleNote">
        <div class="note__title">Regola + esempio</div>
        <div class="note__body" id="ruleText">‚Äî</div>
      </div>

      <div class="qbox">
        <div class="qtext" id="qtext">‚Ä¶</div>

        <!-- area risposte (MCQ / step guidati / open) -->
        <div id="choices" class="choices"></div>

        <div id="openWrap" class="hidden">
          <label class="field">
            <span class="muted">Risposta</span>
            <input id="openInput"
                   type="text"
                   inputmode="decimal"
                   placeholder="Scrivi qui‚Ä¶"
                   autocomplete="off"
                   autocorrect="off"
                   autocapitalize="off"
                   spellcheck="false" />
          </label>

          <div class="keypad" id="keypad"></div>

          <div class="actions">
            <button id="checkOpenBtn" class="btn primary">Conferma</button>
          </div>
        </div>

        <div class="feedback" id="feedback"></div>
      </div>

      <div class="actions">
        <button id="backHomeBtn" class="btn">Home</button>
        <button id="nextBtn" class="btn primary" disabled>Avanti</button>
      </div>
    </section>

    <!-- PROGRESSI DETTAGLIATI -->
    <section class="card hidden" id="progressView">
      <h2>Progressi</h2>
      <p class="muted">Qui vedi punti forti e carenze per competenza.</p>

      <div id="progressBody" class="progressBody"></div>

      <div class="actions">
        <button id="progressHomeBtn" class="btn primary">Torna alla Home</button>
        <button id="resetBtn" class="btn danger">Reset progressi</button>
      </div>
    </section>

    <!-- TOAST -->
    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

    <footer class="footer muted">
      <p class="tiny">PWA ‚Ä¢ Offline ‚Ä¢ Nessun suggerimento tastiera ‚Ä¢ No zoom</p>
    </footer>
  </main>

  
  <!-- Bottom navigation -->
  <nav class="bottomNav" aria-label="Navigazione">
    <div class="bottomNav__inner">
      <button class="navBtn" id="navHome" type="button"><div class="ico">üè†</div><span>Home</span></button>
      <button class="navBtn" id="navTrain" type="button"><div class="ico">üí™</div><span>Allenati</span></button>
      <button class="navBtn" id="navVerify" type="button"><div class="ico">‚úÖ</div><span>Verifica</span></button>
      <button class="navBtn" id="navProgress" type="button"><div class="ico">üìà</div><span>Progressi</span></button>
      <button class="navBtn" id="navSettings" type="button"><div class="ico">‚öôÔ∏è</div><span>Impostazioni</span></button>
    </div>
  </nav>

  <!-- Settings / Diagnostics modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="modal__backdrop" data-close="settings"></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal__head">
        <div>
          <h2 id="settingsTitle">Impostazioni</h2>
          <p class="muted tiny" id="settingsSubtitle">v15</p>
        </div>
        <button class="modal__close" type="button" data-close="settings">√ó</button>
      </div>

      <div class="settingsGrid">
        <div class="settingCard">
          <h3>Accesso</h3>
          <p class="muted tiny">L'app salva i progressi sul dispositivo. Puoi cambiare nome in qualsiasi momento.</p>
          <label class="field">
            <span class="muted">Nome</span>
            <input id="settingsNameInput" type="text" placeholder="Nome" autocomplete="off" />
          </label>
          <div class="actions">
            <button id="settingsSaveName" class="btn primary" type="button">Salva nome</button>
          </div>
        </div>

        <div class="settingCard">
          <h3>Diagnostica</h3>
          <p class="muted tiny">Se qualcosa non va, copia i dettagli e mandali al prof/sviluppatore.</p>
          <div class="actions">
            <button id="copyDiagnostics" class="btn" type="button">Copia diagnostica</button>
            <button id="copyBugReport" class="btn" type="button">Copia segnalazione bug</button>
          </div>
          <div id="diagnosticsPre" class="pre"></div>
        </div>


        <div class="settingCard">
          <h3>Backup progressi</h3>
          <p class="muted tiny">Esporta/Importa i progressi (JSON). Utile se cambi telefono o vuoi fare un reset controllato.</p>

          <div class="actions">
            <button id="exportProgress" class="btn" type="button">Esporta JSON</button>
            <button id="importProgressBtn" class="btn" type="button">Importa JSON</button>
            <button id="resetProgress" class="btn danger" type="button">Reset progressi</button>
          </div>

          <input id="importProgressFile" type="file" accept="application/json" class="hidden" />

          <label class="field">
            <span class="muted">Oppure incolla qui il JSON</span>
            <textarea id="importProgressText" rows="4" placeholder="Incolla qui il JSON esportato..."></textarea>
          </label>
          <div class="actions">
            <button id="importProgressTextBtn" class="btn" type="button">Importa dal testo</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    // Firebase (Auth anonimo + Firestore)
    // IMPORTANTISSIMO: NON usare import statici qui, altrimenti offline/PWA si rompe.
    // Se Firebase non parte, l'app resta utilizzabile offline (solo senza lista classe).
    const firebaseConfig = {
      apiKey: "AIzaSyCFA9VgscJaUBdkwELaGRhM7z8-KUePRuc",
      authDomain: "matematica-953a8.firebaseapp.com",
      projectId: "matematica-953a8",
      storageBucket: "matematica-953a8.firebasestorage.app",
      messagingSenderId: "84797551464",
      appId: "1:84797551464:web:a5692f8080189a69a6dcdd",
      measurementId: "G-C5M1F3YG6T"
    };

    
    // Carichiamo quiz.js SUBITO (non bloccare l'app se Firebase Ë lento/offline)
    import("./quiz.js");

    // Inizializza Firebase in background (se disponibile)
    (async () => {
      try {
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js");
        const { getAuth, signInAnonymously } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js");
        const { getFirestore } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.__FIREBASE__ = { auth, db, signInAnonymously };
      } catch (e) {
        console.warn("Firebase non disponibile (offline o non configurato):", e);
      }
    })();

  </script>
</body>
</html>
