<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />

  <!-- iOS/Android PWA: NO zoom accidentale -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <meta name="theme-color" content="#F8FAFC" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="styles.css" />

  <!-- Fonts (con fallback robusto offline: system-ui) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet" />

  <title>1GL1-GL2 ‚Ä¢ Matematica</title>
</head>

<body>
  <!-- Header identit√† -->
  <header class="topbar">
    <div class="wrap topbar__inner">
      <div class="brand">
        <div class="brand__icon" aria-hidden="true">œÄ</div>
        <div class="brand__text">
          <div class="brand__school">1GL1-GL2 ‚Äì Matematica ‚Äì Algebra</div>
          <div class="brand__title">Prof. G. Gentili</div>
        </div>
      </div>

      <div class="topbar__right">
        <div id="appVersion" class="pill">v28</div>
        <div id="hello" class="pill hidden"></div>
        <button id="settingsTopBtn" class="btn" type="button" title="Impostazioni" data-action="open-settings">&#9881;</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- LANDING ISTITUZIONALE (sempre visibile, onboarding solo al bisogno) -->
    <section class="card landing" id="landing">
      <div class="landing__hero">
        <div>
          <div class="kicker">Classi 1GL1 ‚Äì 1GL2</div>
          <h1>Allenamento strutturato per lo sviluppo del pensiero matematico</h1>
          <p class="muted">Percorsi progressivi, verifiche mirate e analisi delle competenze per uno studio consapevole della matematica.</p>
          <div class="actions">
            <button id="startBtn" class="btn primary" type="button" data-action="start">Inizia il percorso</button>
            <button id="methodBtn" class="btn" type="button" data-action="method">Informazioni sul metodo</button>
          </div>
        </div>
        <div class="landing__aside" aria-hidden="true">
          <div class="landing__badge">Percorso guidato</div>
          <div class="landing__meta">Offline ‚Ä¢ Progressi locali ‚Ä¢ Feedback formativo</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid">
        <div class="miniCard">
          <h3>Progressione guidata</h3>
          <p class="muted">Percorsi organizzati per prerequisiti e livelli di competenza.</p>
        </div>
        <div class="miniCard">
          <h3>Valutazione continua</h3>
          <p class="muted">Monitoraggio delle competenze e individuazione delle aree da rinforzare.</p>
        </div>
        <div class="miniCard">
          <h3>Allenamento mirato</h3>
          <p class="muted">Esercitazioni guidate e richiamo dei contenuti nel tempo.</p>
        </div>
      </div>

      <div class="contextCard" id="methodCard" hidden>
        <div class="contextCard__title">Contesto di utilizzo</div>
        <div class="contextCard__body muted">
          La piattaforma √® utilizzata nelle classi <strong>1GL1 ‚Äì 1GL2</strong> come supporto all‚Äôattivit√† didattica di matematica.<br />
          <strong>Docente responsabile:</strong> Prof. G. Gentili
        </div>
      </div>
    </section>

    <!-- ONBOARDING NOME (solo prima volta) -->
    <section class="card" id="onboarding">
      <h2>Chi sei?</h2>
      <p class="muted">Scrivi il tuo nome (rimane salvato nella PWA).</p>

      <div class="grid one">
        <label class="field">
          <span>Nome</span>
          <input id="nameInput"
                 type="text"
                 placeholder="Es. Gabriele"
                 autocomplete="off"
                 autocorrect="off"
                 autocapitalize="off"
                 spellcheck="false" />
        </label>
      </div>

      <div class="actions">
        <button id="saveNameBtn" class="btn primary" data-action="continue">Continua</button>
      </div>
    </section>

    <!-- HOME -->
    <section class="card hidden" id="home">
      <div class="homeHead">
        <div>
      <h2>Percorso di apprendimento</h2>
      <p class="muted">Percorso guidato con prerequisiti (P0 ‚Üí M1 ‚Üí M2 ‚Üí M3 ‚Üí M4 ‚Üí M5).</p>
        </div>
        <div class="pill" id="statusPill">Stato: ‚Äî</div>
      </div>

      <!-- progressi sintetici + badge (riempiti da quiz.js) -->
      <div id="dashboard" class="dashboard"></div>

      <div class="divider"></div>

      <h3>Classe</h3>
      <p class="muted tiny">Vedi chi sta usando l‚Äôapp in classe e a che percentuale √® arrivato (serve connessione).</p>
      <div id="classmates" class="classmates"></div>

      <div class="actions">
        <button id="trainBtn" class="btn primary" data-action="start-train">Avvia allenamento (consigliato)</button>
        <button id="verifyBtn" class="btn" data-action="start-verify">Avvia verifica</button>
        <button id="errorsBtn" class="btn" data-action="start-errors">Ripeti esercitazioni</button>
        <button id="progressBtn" class="btn" data-action="go-progress">Consulta progressi</button>
      </div>

      <div class="divider"></div>

      <!-- selezione blocco (se consentita) -->
      <h3>Percorso</h3>
      <div id="blocks" class="blocks"></div>

      <p class="muted tiny" id="homeHint"></p>
    </section>

    <!-- QUIZ -->
    <section class="card hidden" id="quiz">
      <div class="quizHead">
        <div>
          <h2 id="quizTitle">Domanda</h2>
          <p class="muted" id="meta"></p>
        </div>
        <div class="pill" id="scorePill">Punti: 0</div>
      </div>

      <div class="progress">
        <div class="progress__bar" id="progressBar"></div>
      </div>

      <!-- Post-it regola + esempio (sempre in Allenamento) -->
      <div class="note" id="ruleNote">
        <div class="note__title">Regola + esempio</div>
        <div class="note__body" id="ruleText">‚Äî</div>
      </div>

      <div class="qbox">
        <div class="qtext" id="qtext">‚Ä¶</div>

        <!-- area risposte (MCQ / step guidati / open) -->
        <div id="choices" class="choices"></div>

        <div id="openWrap" class="hidden">
          <label class="field">
            <span class="muted">Risposta</span>
            <input id="openInput"
                   type="text"
                   inputmode="decimal"
                   placeholder="Scrivi qui‚Ä¶"
                   autocomplete="off"
                   autocorrect="off"
                   autocapitalize="off"
                   spellcheck="false" />
          </label>

          <div class="keypad" id="keypad"></div>

          <div class="actions">
            <button id="checkOpenBtn" class="btn primary" data-action="submit-open">Conferma</button>
          </div>
        </div>

        <div class="feedback" id="feedback"></div>
      </div>

      <div class="actions">
        <button id="backHomeBtn" class="btn" data-action="go-home">Home</button>
        <button id="nextBtn" class="btn primary" data-action="next" disabled>Avanti</button>
      </div>
    </section>

    <!-- PROGRESSI DETTAGLIATI -->
    <section class="card hidden" id="progressView">
      <h2>Progressi</h2>
      <p class="muted">Qui vedi punti forti e carenze per competenza.</p>

      <div id="progressBody" class="progressBody"></div>

      <div class="actions">
        <button id="progressHomeBtn" class="btn primary" data-action="go-home">Torna alla Home</button>
        <button id="resetBtn" class="btn danger" data-action="reset-progress">Reset progressi</button>
      </div>
    </section>

    <!-- TOAST -->
    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

    <footer class="footer muted">
      <p class="tiny">Progetto didattico ‚Ä¢ PWA (offline) ‚Ä¢ Dati salvati localmente ‚Ä¢ Docente responsabile: Prof. G. Gentili</p>
    </footer>
  </main>

  
  <!-- Bottom navigation -->
  <nav class="bottomNav" aria-label="Navigazione">
    <div class="bottomNav__inner">
      <button class="navBtn" id="navHome" type="button" data-action="go-home"><div class="ico">üè†</div><span>Home</span></button>
      <button class="navBtn" id="navTrain" type="button" data-action="start-train"><div class="ico">üí™</div><span>Allenati</span></button>
      <button class="navBtn" id="navVerify" type="button" data-action="start-verify"><div class="ico">‚úÖ</div><span>Verifica</span></button>
      <button class="navBtn" id="navProgress" type="button" data-action="go-progress"><div class="ico">üìà</div><span>Progressi</span></button>
      <button class="navBtn" id="navSettings" type="button" data-action="open-settings"><div class="ico">‚öôÔ∏è</div><span>Impostazioni</span></button>
    </div>
  </nav>

  <!-- Settings / Diagnostics modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="modal__backdrop" data-close="settings"></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal__head">
        <div>
          <h2 id="settingsTitle">Impostazioni</h2>
          <p class="muted tiny" id="settingsSubtitle">v28</p>
        </div>
        <button class="modal__close" type="button" data-close="settings">√ó</button>
      </div>

      <div class="settingsGrid">
        <div class="settingCard">
          <h3>Accesso</h3>
          <p class="muted tiny">L'app salva i progressi sul dispositivo. Puoi cambiare nome in qualsiasi momento.</p>
          <label class="field">
            <span class="muted">Nome</span>
            <input id="settingsNameInput" type="text" placeholder="Nome" autocomplete="off" />
          </label>
          <div class="actions">
            <button id="settingsSaveName" class="btn primary" type="button" data-action="save-name">Salva nome</button>
          </div>
        </div>

        <div class="settingCard">
          <h3>Diagnostica</h3>
          <p class="muted tiny">Se qualcosa non va, copia i dettagli e mandali al prof/sviluppatore.</p>
          <div class="actions">
            <button id="copyDiagnostics" class="btn" type="button" data-action="copy-diagnostics">Copia diagnostica</button>
            <button id="copyBugReport" class="btn" type="button" data-action="copy-bug">Copia segnalazione bug</button>
          </div>
          <div id="diagnosticsPre" class="pre"></div>
        </div>

        <div class="settingCard">
          <h3>Valutazione risposte</h3>
          <p class="muted tiny">Per non confondere, l'app accetta forme equivalenti. Qui puoi scegliere se mostrare e/o avvisare sulla forma standard.</p>
          <label class="checkRow">
            <input id="optSuggestStandard" type="checkbox" />
            <span>Mostra la <b>forma standard</b> quando la risposta √® equivalente</span>
          </label>
          <label class="checkRow">
            <input id="optWarnStandardVerify" type="checkbox" />
            <span>In <b>Verifica</b>: mostra un avviso se non √® in forma standard (non boccia)</span>
          </label>
          <div class="actions">
            <button class="btn" type="button" data-action="save-eval-settings">Salva</button>
          </div>
        </div>

        <div class="settingCard">
          <h3>Allenamento smart</h3>
          <p class="muted tiny">Crea sessioni miste: nuove domande + richiami programmati (spaced repetition) + eventuali errori recenti.</p>
          <label class="checkRow">
            <input id="optSmartSession" type="checkbox" />
            <span>Attiva sessione smart (consigliato)</span>
          </label>
          <div class="grid two">
            <label class="field">
              <span class="muted">Domande per sessione</span>
              <input id="optSessionN" type="number" min="5" max="25" step="1" />
            </label>
            <label class="field">
              <span class="muted">Richiami minimi</span>
              <input id="optReviewMin" type="number" min="0" max="10" step="1" />
            </label>
          </div>
          <div class="actions">
            <button class="btn" type="button" data-action="save-session-settings">Salva</button>
          </div>
        </div>
        <div class="settingCard">
          <h3>Backup progressi</h3>
          <p class="muted tiny">Esporta/Importa i progressi (JSON). Utile se cambi telefono o vuoi fare un reset controllato.</p>

          <div class="actions">
            <button id="exportProgress" class="btn" type="button" data-action="export-progress">Esporta JSON</button>
            <button id="importProgressBtn" class="btn" type="button" data-action="import-progress-file">Importa JSON</button>
            <button id="resetProgress" class="btn danger" type="button" data-action="reset-progress-hard">Reset progressi</button>
          </div>

          <input id="importProgressFile" type="file" accept="application/json" class="hidden" />

          <label class="field">
            <span class="muted">Oppure incolla qui il JSON</span>
            <textarea id="importProgressText" rows="4" placeholder="Incolla qui il JSON esportato..."></textarea>
          </label>
          <div class="actions">
            <button id="importProgressTextBtn" class="btn" type="button" data-action="import-progress-text">Importa dal testo</button>
          </div>
        </div>
        <div class="settingCard">
          <h3>Nuovi capitoli (prof)</h3>
          <p class="muted tiny">Incolla o importa un JSON creato dal prof/ChatGPT per aggiungere o aggiornare capitoli e domande. Non serve toccare il codice.</p>

          <label class="field">
            <span class="muted">JSON contenuti</span>
            <textarea id="importContentText" rows="7" placeholder='Incolla qui il JSON del nuovo capitolo (es. M6) oppure un pacchetto {"catalog":...,"units":[...]}...'></textarea>
          </label>

          <div class="actions">
            <button id="importContentTextBtn" class="btn primary" type="button" data-action="import-content-text">Adatta e aggiorna</button>
            <button id="validateContentBtn" class="btn" type="button" data-action="validate-content">Verifica JSON</button>
          </div>

          <div class="actions">
            <button id="importContentBtn" class="btn" type="button" data-action="import-content-file">Importa da file</button>
            <input id="importContentFile" type="file" accept="application/json" class="hidden" />
            <button id="exportContent" class="btn" type="button" data-action="export-content">Esporta contenuti</button>
            <button id="resetContent" class="btn danger" type="button" data-action="reset-content">Reset contenuti aggiunti</button>
          </div>

          <div id="contentImportStatus" class="pre"></div>
          <p class="muted tiny">Formati supportati: unit√† singola (con <code>id</code> e <code>questions</code>) oppure pacchetto: <code>{"catalog":{...},"units":[...]}</code>.</p>
        </div>

      </div>

    </div>
  </div>

  <script>
  // BOOT MINIMO (iOS PWA safe): se quiz.js non parte, l'app resta navigabile.
  (function(){
    const $=id=>document.getElementById(id);
    function show(id){ const el=$(id); if(el) el.classList.remove('hidden'); }
    function hide(id){ const el=$(id); if(el) el.classList.add('hidden'); }

    // Badge debug (sparisce quando quiz.js prende il controllo)
    try{
      const pill=$('statusPill');
      if(pill) pill.textContent='Stato: boot';
    }catch(e){}

    function goHomeFallback(){ hide('quiz'); hide('progressView'); hide('onboarding'); show('home'); }
    function goProgressFallback(){ hide('quiz'); hide('home'); hide('onboarding'); show('progressView'); }

    const saveBtn=$('saveNameBtn');
    if(saveBtn){
      saveBtn.addEventListener('click', function(){
        const inp=$('nameInput');
        const n=(inp && inp.value ? inp.value.trim() : '');
        if(!n){ try{ const t=$('toast'); if(t){ t.textContent='Scrivi un nome.'; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1800);} }catch(e){}; return; }
        try{ localStorage.setItem('math_name', n); }catch(e){}
        goHomeFallback();
      });
    }

    // bottom nav fallback
    const navHome=$('navHome'); if(navHome) navHome.addEventListener('click', goHomeFallback);
    const navProgress=$('navProgress'); if(navProgress) navProgress.addEventListener('click', goProgressFallback);
    const navTrain=$('navTrain'); if(navTrain) navTrain.addEventListener('click', goHomeFallback);
    const navVerify=$('navVerify'); if(navVerify) navVerify.addEventListener('click', goHomeFallback);

    // se il nome e' gia' salvato, salta onboarding
    try{
      const existing=(localStorage.getItem('math_name')||'').trim();
      if(existing){ goHomeFallback(); }
    }catch(e){}

    // flag per diagnosi
    window.__BOOT_OK = true;
  })();
  </script>

    <script src="./quiz.js" defer></script>

</body>
</html>
